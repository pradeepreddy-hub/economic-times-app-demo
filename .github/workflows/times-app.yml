name: Build and Publish WAR to Artifactory

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      JFROG_CLI_LOG_LEVEL: INFO
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build WAR
        run: mvn -B clean package -DskipTests

      - name: Install JFrog CLI
        uses: jfrog/setup-jfrog-cli@v2

      - name: Configure JFrog CLI and validate auth (temporary)
        env:
          JFROG_URL: ${{ secrets.JFROG_URL }}
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_PASSWORD: ${{ secrets.JFROG_PASSWORD }}
          JFROG_REPO: ${{ secrets.JFROG_REPO }}
        run: |
          set -euo pipefail

          # Basic validation
          if [ -z "${JFROG_URL:-}" ] || [ -z "${JFROG_REPO:-}" ]; then
            echo "ERROR: JFROG_URL and JFROG_REPO must be set as repository secrets."
            exit 1
          fi

          echo "Using JFrog URL: $JFROG_URL"
          jfrog --version || true

          # Test connectivity and authentication using username/password (do not print secrets)
          echo "Testing username/password authentication (no secrets will be printed)..."
          if curl -sSf -u "$JFROG_USERNAME:$JFROG_PASSWORD" "$JFROG_URL/api/system/ping"; then
            echo "User ping OK"
          else
            echo "User ping FAILED - credentials may be invalid or lack permissions"
          fi

          # Configure JFrog CLI with username/password
          jfrog config add artifactory --interactive=false --url="$JFROG_URL" --user="$JFROG_USERNAME" --password="$JFROG_PASSWORD"
          jfrog config use artifactory || true

          echo "JFrog CLI active config (masked):"
          jfrog config show

          # Try jfrog rt ping (may still show 401 if auth invalid)
          jfrog rt ping || true

      - name: Upload WAR to Artifactory
        env:
          JFROG_REPO: ${{ secrets.JFROG_REPO }}
        run: |
          set -euo pipefail

          ARTIFACT_GLOB="target/*.war"
          if ! ls $ARTIFACT_GLOB >/dev/null 2>&1; then
            echo "ERROR: No WAR found at $ARTIFACT_GLOB. Check your build output."
            exit 1
          fi

          # Destination uses repo key from JFROG_REPO. Adjust folder layout as needed.
          DEST="${JFROG_REPO}/${{ github.repository }}/build-${{ github.run_id }}/"

          echo "Uploading $ARTIFACT_GLOB -> $DEST"
          jfrog rt u "$ARTIFACT_GLOB" "$DEST" --flat=true

          echo "Upload finished."

      # Optional: publish build-info (uncomment to enable)
      # - name: Publish build-info to Artifactory
      #   env:
      #     BUILD_NAME: "ci-build"
      #     BUILD_NUMBER: ${{ github.run_id }}
      #   run: |
      #     set -euo pipefail
      #     jfrog rt bce "$BUILD_NAME" "$BUILD_NUMBER"
      #     jfrog rt bp "$BUILD_NAME" "$BUILD_NUMBER"
