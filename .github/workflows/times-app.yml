name: Build and Publish WAR to Artifactory

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build WAR
        run: mvn -B clean package

      - name: Install JFrog CLI
        uses: jfrog/setup-jfrog-cli@v2

      - name: Configure JFrog CLI (non-interactive)
        if: ${{ secrets.JFROG_URL != '' && secrets.JFROG_USERNAME != '' && secrets.JFROG_PASSWORD != '' }}
        env:
          JFROG_URL: ${{ secrets.JFROG_URL }}
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_PASSWORD: ${{ secrets.JFROG_PASSWORD }}
        run: |
          jfrog config add artifactory --interactive=false \
            --url="$JFROG_URL" \
            --user="$JFROG_USERNAME" \
            --password="$JFROG_PASSWORD"

      - name: Upload WAR to Artifactory
        if: ${{ secrets.JFROG_URL != '' && secrets.JFROG_USERNAME != '' && secrets.JFROG_PASSWORD != '' && secrets.JFROG_REPO != '' }}
        env:
          ARTIFACT_PATH: target/*.war
          DEST_REPO: ${{ secrets.JFROG_REPO }}
        run: |
          echo "Uploading ${ARTIFACT_PATH} â†’ ${DEST_REPO}/"
          jfrog rt u "${ARTIFACT_PATH}" "${DEST_REPO}/" --flat=true

      - name: Fail early if Artifactory not configured
        if: ${{ secrets.JFROG_URL == '' || secrets.JFROG_USERNAME == '' || secrets.JFROG_PASSWORD == '' || secrets.JFROG_REPO == '' }}
        run: |
          echo "One or more Artifactory secrets are missing. Skipping upload."
          echo "Required secrets: JFROG_URL, JFROG_USERNAME, JFROG_PASSWORD, JFROG_REPO"
          exit 1
